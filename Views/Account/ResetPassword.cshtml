@model QuanLyChiTieu.ViewModels.ResetPasswordViewModel
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    Layout = "~/Views/Shared/_LayoutLanding.cshtml";
}

<div class="login-page-wrapper">
    <div class="login-container">
        <div class="login-aside">
            <img src="~/images/qmk.jpg" alt="Đặt lại mật khẩu" class="welcome-image" />
        </div>

        <div class="login-form-section">
            <h2 class="form-title text-center">Đặt lại Mật khẩu</h2>

            <form asp-action="ResetPassword" method="post" class="mt-4">
                <div asp-validation-summary="All" class="text-danger mb-3"></div>
                <input type="hidden" asp-for="Email" />

                <div id="step1">
                    <p class="text-center text-muted mb-4">Email của bạn là <strong>@Model.Email</strong>. Nhấn nút bên dưới để nhận mã OTP.</p>
                    <div class="d-grid">
                         <button class="btn btn-primary btn-lg" type="button" id="sendOtpButton">Gửi mã OTP cho tôi</button>
                    </div>
                    <small id="otpMessage" class="form-text d-block text-center mt-3"></small>
                </div>

                <div id="step2" style="display: none;">
                    <p class="text-center text-muted mb-4">Một mã OTP đã được gửi đến <strong>@Model.Email</strong>.</p>
                    <div class="form-group mb-3">
                        <label asp-for="Otp" class="form-label">Mã OTP</label>
                        <input asp-for="Otp" class="form-control" placeholder="Nhập mã gồm 6 số" required />
                    </div>
                     <div class="form-group mb-3">
                        <label asp-for="NewPassword" class="form-label">Mật khẩu mới</label>
                        <input asp-for="NewPassword" class="form-control" required />
                    </div>
                     <div class="form-group mb-4">
                        <label asp-for="ConfirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                        <input asp-for="ConfirmPassword" class="form-control" required />
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Xác nhận & Đặt lại</button>
                    </div>
                </div>
            </form>

             <div class="text-center mt-4">
                <a asp-controller="Account" asp-action="Login" class="forgot-password-link">Quay lại Đăng nhập</a>
            </div>
        </div>
    </div>
</div>


@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const sendOtpButton = document.getElementById('sendOtpButton');
                const otpMessage = document.getElementById('otpMessage');
                const step1 = document.getElementById('step1');
                const step2 = document.getElementById('step2');
                const emailInput = document.querySelector('input[name="Email"]');

                // Tìm token được render bởi form tag helper
                const tokenInput = document.querySelector('form[action="/Account/ResetPassword"] input[name="__RequestVerificationToken"]');

                sendOtpButton.addEventListener('click', function() {
                    sendOtpButton.disabled = true;
                    sendOtpButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang gửi...';
                    otpMessage.textContent = '';

                    fetch('@Url.Action("SendResetOtp", "Account")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': tokenInput.value
                        },
                        body: 'email=' + encodeURIComponent(emailInput.value)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Ẩn bước 1 và hiện bước 2
                            step1.style.display = 'none';
                            step2.style.display = 'block';
                        } else {
                            otpMessage.textContent = 'Lỗi: ' + data.message;
                            otpMessage.className = 'form-text text-danger d-block text-center mt-3';
                            sendOtpButton.disabled = false;
                            sendOtpButton.innerHTML = 'Gửi lại mã OTP';
                        }
                    })
                    .catch(error => {
                         otpMessage.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
                         otpMessage.className = 'form-text text-danger d-block text-center mt-3';
                         sendOtpButton.disabled = false;
                         sendOtpButton.innerHTML = 'Gửi lại mã OTP';
                    });
                });
            });
        </script>
}